<!DOCTYPE html>
<html>
<head>
    <title>Data Lineage Visualization</title>
    <!-- External library CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lineage.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/dagre-d3@0.6.4/dist/dagre-d3.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Add Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Data Lineage Visualization</a>
            <div class="view-toggle btn-group" role="group">
                <button class="btn btn-light active" onclick="toggleView('graph')">Graph View</button>
                <button class="btn btn-light" onclick="toggleView('table')">Table View</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Update the Button Toolbar -->
        <div class="btn-toolbar" role="toolbar">
            <div class="btn-group me-2" role="group">
                <button class="btn btn-outline-primary graph-only" onclick="downloadSVG('png')">
                    <i class="bi bi-download"></i> Save as PNG
                </button>
                <button class="btn btn-outline-primary graph-only" onclick="downloadSVG('pdf')">
                    <i class="bi bi-file-pdf"></i> Save as PDF
                </button>
                <button class="btn btn-outline-success table-only hidden" onclick="downloadTableExcel()">
                    <i class="bi bi-file-excel"></i> Save as Excel
                </button>
                <!-- New buttons for column toggling -->
                <button class="btn btn-outline-secondary graph-only" onclick="hideNonDependentColumns()">
                    Hide Non-Dependent Columns
                </button>
                <button class="btn btn-outline-secondary graph-only" onclick="showAllColumns()">
                    Show All Columns
                </button>
            </div>
            <!-- Removed search input -->
        </div>

        <!-- Visualization Container -->
        <div class="visualization-container">
            <svg width="100%" height="100%">
                <g transform="translate(20,20)"/>
            </svg>
        </div>

        <!-- Table Container -->
        <div class="table-container">
            <table id="lineageTable" 
                   class="table table-striped"
                   data-toggle="table"
                   data-search="true"
                   data-sort-name="tableName"
                   data-sort-order="asc">
                <thead>
                    <tr>
                        <th data-field="tableName" data-sortable="true">Table Name</th>
                        <th data-field="columnName" data-sortable="true">Column Name</th>
                        <th data-field="sourceTable" data-sortable="true">Source Table</th>
                        <th data-field="sourceColumn" data-sortable="true">Source Column</th>
                        <th data-field="expression" data-sortable="true">Expression</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Before external script, expose dynamic data -->
    <script>
        window.originalData = {{ data|safe }};
    </script>
    <!-- External libraries JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
    
    <!-- Load custom JavaScript from external file as a module -->
    <script type="module" src="{{ url_for('static', filename='js/lineage.js') }}"></script>
</body>
</html>